I"c
<p>In a <a href="https://www.gartner.com/smarterwithgartner/chatbots-will-appeal-to-modern-workers">recent study</a> by Gartner, they estimated that as many as 70% of white collar workers will interact with chat bots on a daily basis by 2022. Just this year in South Africa, we have seen a number of multinationals launch their chat bot technology alongside other market leaders.</p>

<ul>
  <li><a href="https://www.iol.co.za/technology/multichoice-launches-chatbot-to-boost-its-service-67353507-b96f-4d6a-92b9-257d7988635d">Multichoice</a></li>
  <li><a href="https://www.itnewsafrica.com/2021/09/nedbank-launches-enbi-a-new-intelligent-chatbot-assistant/">Nedbank</a></li>
  <li><a href="https://www.iol.co.za/business-report/companies/eskom-enhances-its-digital-platforms-by-launching-a-chatbot-alfred-and-enhancing-its-app-c9e50f68-fad7-40a1-a133-c7b3090fdafd">Eskom</a></li>
  <li><a href="https://www.sanews.gov.za/south-africa/access-all-covid-19-facts-whatsapp">Deparment of Health</a></li>
  <li><a href="https://ewn.co.za/2020/05/02/carling-black-label-launches-whatsapp-line-to-help-gbv-victims">Carling Black Label</a></li>
  <li><a href="https://www.westerncape.gov.za/news/new-healthbot-launched-high-risk-patients-during-covid-19">Western Cape Government</a></li>
</ul>

<p>We have also seen bots find homes inside large organizations, embedded into applications like Slack, Discord and Microsoft Teams. Usually these bots offer question and answer services and are quickly replacing the intranet FAQ websites we have come to know and love. Microsoft released the Bot Framework in 2016 and after taking it for a spin, i found an <a href="https://github.com/microsoft/botframework-sdk/issues/94">issue</a> that prevented me using it in a real world application.</p>

<p>More recently i was asked to help a team responsible for managing the Bot Framework inside a large organization design a solution for the management of knowledge base content. Specifically, the Bot Framework had been integrated with the Microsoft QnA Maker service and the team had been managing the question and answer pairs manually. The process to get questions added to the company knowledge base consisted of sending one of the team members a Microsoft Teams message with your question and answer content, which they would then add via the QnA Maker web interface. With the bot catching on and over 60 teams submitting question and answer content, the process was not scaling and all development time was now spent managing content.</p>

<p>After chatting with a few friends, it was clear that we needed to replace the developers with a bot that could allow users to add their own content.</p>

<h3 id="prerequisites">Prerequisites</h3>

<ul>
  <li>Install <a href="https://visualstudio.microsoft.com/">Visual Studio</a></li>
  <li>Install <a href="https://github.com/microsoft/BotFramework-Emulator/releases">Bot Framework Emulator</a></li>
  <li>Install <a href="https://marketplace.visualstudio.com/items?itemName=BotBuilder.botbuilderv4">Bot Framework SDK Templates</a></li>
  <li><a href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/quickstarts/create-publish-knowledge-base?tabs=v1">Create a knowledge base</a> on QnA Maker</li>
  <li>The namespace used in this blog post is CoreBotAzureBootcampDemo.</li>
</ul>

<h3 id="plumbing">Plumbing</h3>

<p>First up, we need to open Visual Studio and create a new project based on the newly installed <code class="language-plaintext highlighter-rouge">Core Bot</code> template. The template comes with a whole bunch of example files and directories that we donâ€™t need, so lets start by deleting the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BookingDetails.cs</code></li>
  <li><code class="language-plaintext highlighter-rouge">FlightBookingRecognizer.cs</code></li>
  <li><code class="language-plaintext highlighter-rouge">BookingDialog.cs</code></li>
  <li><code class="language-plaintext highlighter-rouge">CancelAndHelpDialog.cs</code></li>
  <li><code class="language-plaintext highlighter-rouge">DateResolverDialog.cs</code></li>
  <li><code class="language-plaintext highlighter-rouge">CognitiveModels</code></li>
</ul>

<p>We then need to add a few Nuget packages to our project.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet add package AdaptiveCards
dotnet add package Microsoft.Azure.CognitiveServices.Knowledge.QnAMaker
dotnet add package Microsoft.Bot.Builder.AI.QnA 
</code></pre></div></div>

<p>We also need to add our QnA Maker configuration to our <code class="language-plaintext highlighter-rouge">appsettings.json</code> file.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">KnowledgebaseId</code> - this can be found in the QnA maker  under settings.</li>
  <li><code class="language-plaintext highlighter-rouge">QnAEndpointKey</code> - this can be found in the QnA maker  under settings</li>
  <li><code class="language-plaintext highlighter-rouge">ResourceName</code> - this is the name of the QnA Maker resource in Azure</li>
  <li><code class="language-plaintext highlighter-rouge">SubscriptionKey</code> -  this can be found in the Azure portal under <code class="language-plaintext highlighter-rouge">Keys and Endpoint</code> on the QnA Maker resource</li>
</ul>

<p>Your <code class="language-plaintext highlighter-rouge">appsettings.json</code> should look something like this once you are done.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">MicrosoftAppId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">MicrosoftAppPassword</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">QnAEndpointKey</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">df9e32de-d666-4dcb-f7g5-1275ddh4ksnf</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">KnowledgebaseId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">3f113c38-dcc8-4bf7-6723-6a6c946fe433</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">ResourceName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dh-demo-qna</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">SubscriptionKey</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">d91cgf927410ff47b738bdbf64a91020</span><span class="dl">"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lastly, we need to remove some dependencies that were wired up in the <code class="language-plaintext highlighter-rouge">Startup.cs</code> file. In particular, we can remove these lines.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Register LUIS recognizer</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">FlightBookingRecognizer</span><span class="p">&gt;();</span>
 
<span class="c1">// Register the BookingDialog.</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">BookingDialog</span><span class="p">&gt;();</span>
</code></pre></div></div>

<h3 id="qnamakerservice">QNAMakerService</h3>

<p>Integrating with the QnA Maker API is fairly easy using the Nuget packages we installed earlier. Our bot will need to do two things.</p>

<ul>
  <li>Get an answer to a question</li>
  <li>Add additional questions to the knowledge base</li>
</ul>

<p>So go ahead and create a new <code class="language-plaintext highlighter-rouge">Services</code> directory in the root of your project, and then add a new class called <code class="language-plaintext highlighter-rouge">QNAMakerService.cs</code> with the following content.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.Azure.CognitiveServices.Knowledge.QnAMaker</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.CognitiveServices.Knowledge.QnAMaker.Models</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder.AI.QnA</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CoreBotAzureBootcampDemo.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IQNAMakerService</span>
    <span class="p">{</span>
        <span class="n">Task</span><span class="p">&lt;</span><span class="n">QueryResult</span><span class="p">[</span><span class="k">]&gt;</span> <span class="nf">GetQuestionResults</span><span class="p">(</span><span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">,</span> <span class="n">ITurnContext</span> <span class="n">turnContext</span><span class="p">);</span>
        <span class="n">Task</span> <span class="nf">CreateQuestion</span><span class="p">(</span><span class="kt">string</span> <span class="n">question</span><span class="p">,</span> <span class="kt">string</span> <span class="n">answer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">QNAMakerService</span> <span class="p">:</span> <span class="n">IQNAMakerService</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">readonly</span> <span class="n">IConfiguration</span> <span class="n">_configuration</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">QNAMakerService</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">QueryResult</span><span class="p">[</span><span class="k">]&gt;</span> <span class="nf">GetQuestionResults</span><span class="p">(</span><span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">,</span> <span class="n">ITurnContext</span> <span class="n">turnContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">qnaMaker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">QnAMaker</span><span class="p">(</span><span class="k">new</span> <span class="n">QnAMakerEndpoint</span>
            <span class="p">{</span>
                <span class="n">KnowledgeBaseId</span> <span class="p">=</span> <span class="n">_configuration</span><span class="p">[</span><span class="s">"KnowledgebaseId"</span><span class="p">],</span>
                <span class="n">EndpointKey</span> <span class="p">=</span> <span class="n">_configuration</span><span class="p">[</span><span class="s">"QnAEndpointKey"</span><span class="p">],</span>
                <span class="n">Host</span> <span class="p">=</span> <span class="s">$"https://</span><span class="p">{</span><span class="n">_configuration</span><span class="p">[</span><span class="s">"ResourceName"</span><span class="p">]}</span><span class="s">.azurewebsites.net/qnamaker"</span>
        <span class="p">},</span> <span class="k">null</span><span class="p">,</span> <span class="n">httpClient</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">QnAMakerOptions</span> <span class="p">{</span> <span class="n">Top</span> <span class="p">=</span> <span class="m">1</span> <span class="p">};</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">qnaMaker</span><span class="p">.</span><span class="nf">GetAnswersAsync</span><span class="p">(</span><span class="n">turnContext</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CreateQuestion</span><span class="p">(</span><span class="kt">string</span> <span class="n">question</span><span class="p">,</span> <span class="kt">string</span> <span class="n">answer</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">endpoint</span> <span class="p">=</span> <span class="s">$"https://</span><span class="p">{</span><span class="n">_configuration</span><span class="p">[</span><span class="s">"ResourceName"</span><span class="p">]}</span><span class="s">.cognitiveservices.azure.com"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">QnAMakerClient</span><span class="p">(</span><span class="k">new</span> <span class="nf">ApiKeyServiceClientCredentials</span><span class="p">(</span><span class="n">_configuration</span><span class="p">[</span><span class="s">"SubscriptionKey"</span><span class="p">]))</span> <span class="p">{</span> <span class="n">Endpoint</span> <span class="p">=</span> <span class="n">endpoint</span> <span class="p">};</span>
            <span class="kt">var</span> <span class="n">update</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">Knowledgebase</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">_configuration</span><span class="p">[</span><span class="s">"KnowledgebaseId"</span><span class="p">],</span> <span class="k">new</span> <span class="n">UpdateKbOperationDTO</span>
            <span class="p">{</span>
                <span class="n">Add</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateKbOperationDTOAdd</span>
                <span class="p">{</span>
                    <span class="n">QnaList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">QnADTO</span><span class="p">&gt;</span> <span class="p">{</span>
                        <span class="k">new</span> <span class="n">QnADTO</span> <span class="p">{</span>
                            <span class="n">Questions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">question</span> <span class="p">},</span>
                            <span class="n">Answer</span> <span class="p">=</span> <span class="n">answer</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="n">Update</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
                <span class="n">Delete</span> <span class="p">=</span> <span class="k">null</span>
            <span class="p">});</span> <span class="p">;</span>

            <span class="k">await</span> <span class="nf">MonitorOperation</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">update</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">Knowledgebase</span><span class="p">.</span><span class="nf">PublishAsync</span><span class="p">(</span><span class="n">_configuration</span><span class="p">[</span><span class="s">"KnowledgebaseId"</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Operation</span><span class="p">&gt;</span> <span class="nf">MonitorOperation</span><span class="p">(</span><span class="n">QnAMakerClient</span> <span class="n">client</span><span class="p">,</span> <span class="n">Operation</span> <span class="n">operation</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">20</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="n">OperationState</span> <span class="p">==</span> <span class="n">OperationStateType</span><span class="p">.</span><span class="n">NotStarted</span> <span class="p">||</span> <span class="n">operation</span><span class="p">.</span><span class="n">OperationState</span> <span class="p">==</span> <span class="n">OperationStateType</span><span class="p">.</span><span class="n">Running</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Waiting for operation: {0} to complete."</span><span class="p">,</span> <span class="n">operation</span><span class="p">.</span><span class="n">OperationId</span><span class="p">);</span>
                <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>
                <span class="n">operation</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">Operations</span><span class="p">.</span><span class="nf">GetDetailsAsync</span><span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="n">OperationId</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="n">OperationState</span> <span class="p">!=</span> <span class="n">OperationStateType</span><span class="p">.</span><span class="n">Succeeded</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Operation </span><span class="p">{</span><span class="n">operation</span><span class="p">.</span><span class="n">OperationId</span><span class="p">}</span><span class="s"> failed to completed."</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">operation</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Our <code class="language-plaintext highlighter-rouge">QNAMakerService</code> makes use of the configuration that we added further up along with the QnA Maker SDK to provide methods that allow us to easily create questions, as well as search for answers in our knowledge base. For this to be useful via a chat bot, we need to call this service from a dialog that guides the user through a conversation in order to gather all the required inputs to carry out the operation.</p>

<h3 id="dialogs">Dialogs</h3>

<p>The Bot Framework has a built in type called <code class="language-plaintext highlighter-rouge">WaterfallDialog</code> which provides us with functionality to guide users through a series of steps to gather information. We will need 3 waterfall dialogs.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MainDialog.cs</code> - this is the main entry point. You can think of the <code class="language-plaintext highlighter-rouge">MainDialog</code> as a router, routing the user to either <code class="language-plaintext highlighter-rouge">AddQuestionDialog</code> or <code class="language-plaintext highlighter-rouge">AskQuestionDialog</code> depending on what they want to do.</li>
  <li><code class="language-plaintext highlighter-rouge">AddQuestionDialog.cs</code> - this dialog asks the user for the question and answer they want to add to the knowledge base.</li>
  <li><code class="language-plaintext highlighter-rouge">AskQuestionDialog.cs</code> - this dialog simply queries the knowledge base for your question and send you the answer.</li>
</ul>

<p>Lets start by creating a new class in the <code class="language-plaintext highlighter-rouge">Dialogs</code> directory called <code class="language-plaintext highlighter-rouge">AskQuestionDialog</code>, giving it the following content.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.Bot.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder.Dialogs</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.CognitiveServices.Knowledge</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder.AI.QnA</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CoreBotAzureBootcampDemo.Services</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CoreBotAzureBootcampDemo.Dialogs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AskQuestionDialog</span> <span class="p">:</span> <span class="n">ComponentDialog</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IConfiguration</span> <span class="n">_configuration</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHttpClientFactory</span> <span class="n">_httpClientFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IQNAMakerService</span> <span class="n">_qnaMakerService</span><span class="p">;</span>
        
        <span class="k">public</span> <span class="nf">AskQuestionDialog</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">,</span> 
            <span class="n">IHttpClientFactory</span> <span class="n">httpClientFactory</span><span class="p">,</span>
            <span class="n">IQNAMakerService</span> <span class="n">qnaMakerService</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">AskQuestionDialog</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">_qnaMakerService</span> <span class="p">=</span> <span class="n">qnaMakerService</span><span class="p">;</span>
            <span class="n">_configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
            <span class="n">_httpClientFactory</span> <span class="p">=</span> <span class="n">httpClientFactory</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">steps</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WaterfallStep</span><span class="p">[]</span>
            <span class="p">{</span>
                <span class="n">QuestionStepAsync</span><span class="p">,</span>
                <span class="n">AnswerStepAsync</span><span class="p">,</span>
            <span class="p">};</span>

            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">WaterfallDialog</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">WaterfallDialog</span><span class="p">),</span> <span class="n">steps</span><span class="p">));</span>
            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">TextPrompt</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">TextPrompt</span><span class="p">)));</span>

            <span class="n">InitialDialogId</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">WaterfallDialog</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">QuestionStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">PromptAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">TextPrompt</span><span class="p">),</span> <span class="k">new</span> <span class="n">PromptOptions</span>
            <span class="p">{</span>
                <span class="n">Prompt</span> <span class="p">=</span> <span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">"How can i help you today?"</span><span class="p">)</span>

            <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">AnswerStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_qnaMakerService</span><span class="p">.</span><span class="nf">GetQuestionResults</span><span class="p">(</span><span class="n">_httpClientFactory</span><span class="p">.</span><span class="nf">CreateClient</span><span class="p">(),</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">response</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">SendActivityAsync</span><span class="p">(</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Answer</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">SendActivityAsync</span><span class="p">(</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">"No answers were found for that question."</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">EndDialogAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">:</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The dialog itself is pretty simple, asking the user <code class="language-plaintext highlighter-rouge">"How can i help you today?"</code> before searching our knowledge base for any answers. You will notice the use of our <code class="language-plaintext highlighter-rouge">QNAMakerService</code> which we authored further up. In the event that no answers can be found, our dialog will return a response of <code class="language-plaintext highlighter-rouge">"No answers were found for that question."</code> before ending the conversation.</p>

<p>Next we need a way to let our users contribute their own questions and answers. To do this, lets create another class in the <code class="language-plaintext highlighter-rouge">Dialogs</code> directory, this time calling it <code class="language-plaintext highlighter-rouge">AddQuestionDialog</code> and giving it the following content.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">CoreBotAzureBootcampDemo.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder.Dialogs</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CoreBotAzureBootcampDemo.Dialogs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AddQuestionDialog</span> <span class="p">:</span> <span class="n">ComponentDialog</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IConfiguration</span> <span class="n">_configuration</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IQNAMakerService</span> <span class="n">_qnaMakerService</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">AddQuestionDialog</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">IQNAMakerService</span> <span class="n">qnaMakerService</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">AddQuestionDialog</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">_qnaMakerService</span> <span class="p">=</span> <span class="n">qnaMakerService</span><span class="p">;</span>
            <span class="n">_configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">steps</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WaterfallStep</span><span class="p">[]</span>
            <span class="p">{</span>
                <span class="n">QuestionStepAsync</span><span class="p">,</span>
                <span class="n">AnswerStepAsync</span><span class="p">,</span>
                <span class="n">ConfirmStepAsync</span><span class="p">,</span>
                <span class="n">SummaryStepAsync</span>
            <span class="p">};</span>
            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">ConfirmPrompt</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">ConfirmPrompt</span><span class="p">)));</span>
            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">WaterfallDialog</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">WaterfallDialog</span><span class="p">),</span> <span class="n">steps</span><span class="p">));</span>
            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">TextPrompt</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">TextPrompt</span><span class="p">)));</span>

            <span class="n">InitialDialogId</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">WaterfallDialog</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">QuestionStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">PromptAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">TextPrompt</span><span class="p">),</span> <span class="k">new</span> <span class="n">PromptOptions</span>
            <span class="p">{</span>
                <span class="n">Prompt</span> <span class="p">=</span> <span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">"Please enter the question."</span><span class="p">)</span>
            <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">AnswerStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Question"</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">PromptAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">TextPrompt</span><span class="p">),</span> <span class="k">new</span> <span class="n">PromptOptions</span>
            <span class="p">{</span>
                <span class="n">Prompt</span> <span class="p">=</span> <span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">"Please enter the answer."</span><span class="p">)</span>
            <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">ConfirmStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Answer"</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">SendActivityAsync</span><span class="p">(</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">$"The following data will be added to your knowledge base. \n\n"</span> <span class="p">+</span>
                <span class="s">$"**Question**:  </span><span class="p">{</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Question"</span><span class="p">]}</span><span class="s"> \n\n"</span> <span class="p">+</span>
                <span class="s">$"**Answer**: </span><span class="p">{</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Answer"</span><span class="p">]}</span><span class="s">"</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">PromptAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">ConfirmPrompt</span><span class="p">),</span> <span class="k">new</span> <span class="n">PromptOptions</span>
            <span class="p">{</span>
                <span class="n">Prompt</span> <span class="p">=</span> <span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">"Is everything correct?"</span><span class="p">)</span>
            <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">SummaryStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="kt">bool</span><span class="p">)</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Result</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">await</span> <span class="n">_qnaMakerService</span><span class="p">.</span><span class="nf">CreateQuestion</span><span class="p">(</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Question"</span><span class="p">].</span><span class="nf">ToString</span><span class="p">(),</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Answer"</span><span class="p">].</span><span class="nf">ToString</span><span class="p">());</span>

                <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">SendActivityAsync</span><span class="p">(</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">$"The following data has been added to your knowledge base. \n\n"</span> <span class="p">+</span>
                    <span class="s">$"**Question**:  </span><span class="p">{</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Question"</span><span class="p">]}</span><span class="s"> \n\n"</span> <span class="p">+</span>
                    <span class="s">$"**Answer**: </span><span class="p">{</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Answer"</span><span class="p">]}</span><span class="s">"</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">);</span>

                <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">EndDialogAsync</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">EndDialogAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">:</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>In this dialog we ask the user to provide us with a question and an answer. The user is then asked to confirm the data before the bot uploads it to the QnAMaker service in the <code class="language-plaintext highlighter-rouge">SummaryStepAsync</code> step.</p>

<p>Now that we have a dialog to both ask a question, as well as contribute a question, we need to setup our <code class="language-plaintext highlighter-rouge">MainDialog</code> to route the user appropriately. Since we only have two actions, lets crack open <code class="language-plaintext highlighter-rouge">MainDialog.cs</code> and use a card to ask the user which action they would like to perform.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">AdaptiveCards</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CoreBotAzureBootcampDemo.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder.Dialogs</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Builder.Dialogs.Choices</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Bot.Schema</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CoreBotAzureBootcampDemo.Dialogs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MainDialog</span> <span class="p">:</span> <span class="n">ComponentDialog</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IConfiguration</span> <span class="n">_configuration</span><span class="p">;</span>
        <span class="k">public</span> <span class="nf">MainDialog</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">MainDialog</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">,</span> 
                          <span class="n">IQNAMakerService</span> <span class="n">qnaMakerService</span><span class="p">,</span>
                          <span class="n">IHttpClientFactory</span> <span class="n">httpClientFactory</span><span class="p">,</span>
                          <span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">MainDialog</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">_configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>

            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">AskQuestionDialog</span><span class="p">(</span><span class="n">_configuration</span><span class="p">,</span> <span class="n">httpClientFactory</span><span class="p">,</span> <span class="n">qnaMakerService</span><span class="p">));</span>
            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">AddQuestionDialog</span><span class="p">(</span><span class="n">_configuration</span><span class="p">,</span> <span class="n">qnaMakerService</span><span class="p">));</span>

            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">ChoicePrompt</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">ChoicePrompt</span><span class="p">)));</span>
            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">TextPrompt</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">TextPrompt</span><span class="p">)));</span>

            <span class="nf">AddDialog</span><span class="p">(</span><span class="k">new</span> <span class="nf">WaterfallDialog</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">WaterfallDialog</span><span class="p">),</span> <span class="k">new</span> <span class="n">WaterfallStep</span><span class="p">[]</span>
            <span class="p">{</span>
                <span class="n">IntroStepAsync</span><span class="p">,</span>
                <span class="n">ActStepAsync</span><span class="p">,</span>
                <span class="n">FinalStepAsync</span><span class="p">,</span>
            <span class="p">}));</span>

            <span class="n">InitialDialogId</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">WaterfallDialog</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">IntroStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="n">stepContext</span><span class="p">?.</span><span class="n">Options</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">SendActivityAsync</span><span class="p">(</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="s">"What would you like to do today?"</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">operationList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="s">"Ask a question"</span><span class="p">,</span> <span class="s">"Contribute a question"</span> <span class="p">};</span>
           
            <span class="kt">var</span> <span class="n">card</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AdaptiveCard</span><span class="p">(</span><span class="k">new</span> <span class="nf">AdaptiveSchemaVersion</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Actions</span> <span class="p">=</span> <span class="n">operationList</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">choice</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">AdaptiveSubmitAction</span>
                <span class="p">{</span>
                    <span class="n">Title</span> <span class="p">=</span> <span class="n">choice</span><span class="p">,</span>
                    <span class="n">Data</span> <span class="p">=</span> <span class="n">choice</span><span class="p">,</span>  
                <span class="p">}).</span><span class="n">ToList</span><span class="p">&lt;</span><span class="n">AdaptiveAction</span><span class="p">&gt;(),</span>
            <span class="p">};</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">PromptAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">ChoicePrompt</span><span class="p">),</span> <span class="k">new</span> <span class="n">PromptOptions</span>
            <span class="p">{</span>
                <span class="n">Prompt</span> <span class="p">=</span> <span class="p">(</span><span class="n">Activity</span><span class="p">)</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Attachment</span><span class="p">(</span><span class="k">new</span> <span class="n">Attachment</span>
                <span class="p">{</span>
                    <span class="n">ContentType</span> <span class="p">=</span> <span class="n">AdaptiveCard</span><span class="p">.</span><span class="n">ContentType</span><span class="p">,</span>
                    <span class="n">Content</span> <span class="p">=</span> <span class="n">JObject</span><span class="p">.</span><span class="nf">FromObject</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
                <span class="p">}),</span>
                <span class="n">Choices</span> <span class="p">=</span> <span class="n">ChoiceFactory</span><span class="p">.</span><span class="nf">ToChoices</span><span class="p">(</span><span class="n">operationList</span><span class="p">),</span>
                <span class="n">Style</span> <span class="p">=</span> <span class="n">ListStyle</span><span class="p">.</span><span class="n">None</span><span class="p">,</span>
            <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">ActStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Operation"</span><span class="p">]</span> <span class="p">=</span> <span class="p">((</span><span class="n">FoundChoice</span><span class="p">)</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Result</span><span class="p">).</span><span class="n">Value</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">operation</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">stepContext</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">"Operation"</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"Ask a question"</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">BeginDialogAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">AskQuestionDialog</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"Contribute a question"</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">BeginDialogAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">AddQuestionDialog</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">NextAsync</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">DialogTurnResult</span><span class="p">&gt;</span> <span class="nf">FinalStepAsync</span><span class="p">(</span><span class="n">WaterfallStepContext</span> <span class="n">stepContext</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">text</span> <span class="p">=</span> <span class="s">"Is there anything else we can do for you?"</span><span class="p">;</span>
            <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">SendActivityAsync</span><span class="p">(</span><span class="n">MessageFactory</span><span class="p">.</span><span class="nf">Text</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">stepContext</span><span class="p">.</span><span class="nf">ReplaceDialogAsync</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">MainDialog</span><span class="p">),</span> <span class="k">new</span> <span class="p">{</span> <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>
<p>We pretty much have everything we need at this point. One thing to note is that when a user connects to the conversation the <code class="language-plaintext highlighter-rouge">DialogAndWelcomeBot</code> class loads a greeting from <code class="language-plaintext highlighter-rouge">Cards\welcomCard.json</code> which defaults to a generic Bot Framework message with links to their documentation. We can go ahead and change this, i updated mine for this post.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">$schema</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://adaptivecards.io/schemas/adaptive-card.json</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AdaptiveCard</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Image</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">url</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQtB3AwMUeNoq4gUBGe6Ocj8kyh3bXa9ZbV7u1fVKQoyKFHdkqU</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">size</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">stretch</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TextBlock</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">spacing</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">medium</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">size</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">default</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">weight</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bolder</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Welcome to Azure Bootcamp 2021!</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">wrap</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">maxLines</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TextBlock</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">size</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">default</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">isSubtle</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">In this session we will look at what it takes to update our knowledge bases using this bot. The session is accompanied by a blog post, which you can find below.</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">wrap</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">maxLines</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="dl">"</span><span class="s2">actions</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Action.OpenUrl</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Visit Blog</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">url</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://www.taylorgibb.com/building-bots-with-bots</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="wiring-it-up">Wiring It Up</h3>

<p>Lastly we need to add <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code> and <code class="language-plaintext highlighter-rouge">IQNAMakerService</code> to our dependency injection container. To do that, we can open our <code class="language-plaintext highlighter-rouge">Startup.cs</code> file and add the following lines to the <code class="language-plaintext highlighter-rouge">ConfigureServices</code> method.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddHttpClient</span><span class="p">();</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IQNAMakerService</span><span class="p">,</span> <span class="n">QNAMakerService</span><span class="p">&gt;();</span>
</code></pre></div></div>

<p>Thats pretty much all there is too it, lets see how it looks in action using the Bot Framework Emulator.</p>

:ET