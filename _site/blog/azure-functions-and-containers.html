<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Azure Functions + Container Instances</title> <meta name="description" content="I have a node.js application that does some short-lived work and for years i have used crontab to execute the application on a schedule. This would run the a..." /> <meta property="og:image" content="https://taylorgibb.github.io/assets/facebook.png"/> <link rel="icon" href="https://taylorgibb.github.io/assets/favicon.png"> <link rel="apple-touch-icon" href="https://taylorgibb.github.io/assets/touch-icon.png"> <link rel="stylesheet" href="https://taylorgibb.github.io/assets/core.css"> <link rel="canonical" href="https://taylorgibb.github.io/blog/azure-functions-and-containers"> <link rel="alternate" type="application/atom+xml" title="Taylor Gibb" href="https://taylorgibb.github.io/feed.xml" /> <link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"> <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> </head> <body> <div class="logo-container"> <div class="logo-wrapper"> <img src="/assets/avatar.png" class="logo-avatar"> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Azure Functions + Container Instances</h1> <time class="code">August 16, 2018</time> </div> <div class="divider"></div> <p>I have a node.js application that does some short-lived work and for years i have used crontab to execute the application on a schedule. This would run the application until termination and then the machine would wait for crontab to start the process all over again. Recently, i got an urge to fix this and started looking at Docker. Im sure everyone knows what Docker is, so im going to cut to the chase. There were a few things that crossed my mind:</p> <ul> <li>I could rent a VM and install Docker and use cron to run the container on a schedule</li> <li>I could have an always running Docker container on ACI and use cron inside the container</li> <li>I could have a time based Azure function that creates and deletes containers on demand</li> </ul> <p>I ended up going with the last approach based on the costing shown in this <a href="https://azure.com/e/38ccb2b0d20b48358113517def97cdb6">Azure Pricing Calculator estimate</a> that i put together. In terms of pricing, the virtual machine, which is an Azure A0 instance weighs in at 0.75GBs of RAM and sports a single Intel Xeon E5-2630 v3 core with a price tag of $19.74 per month. Option two: running an always on container as an Azure Container Instance with 1GB of RAM and 1 vCPU would set us back $51.84 per month, with the last option of using Azure Functions to create and delete the containers on the same spec hardware coming in at $12.96 per month. It’s also worth noting that Virtual Machines are billed per hour, while Azure Container Instances are billed per second.</p> <h4 id="container">Container</h4> <p>The first thing i needed to do is actually containerize the application, which was ridiculously easy. We can start with an open source base image that already had node and python configured and craft the following <code class="language-plaintext highlighter-rouge">Dockerfile</code>. Everyone’s <code class="language-plaintext highlighter-rouge">Dockerfile</code> is going to look different, but nevertheless, this is what it took to containerize my application.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FROM</span> <span class="n">beevelop</span><span class="o">/</span><span class="n">nodejs</span><span class="o">-</span><span class="n">python</span><span class="ss">:latest</span>
<span class="no">WORKDIR</span> <span class="sr">/app
COPY package.json /</span><span class="n">app</span>
<span class="no">RUN</span> <span class="n">npm</span> <span class="n">install</span>
<span class="no">COPY</span> <span class="p">.</span> <span class="nf">/</span><span class="n">app</span>
<span class="no">CMD</span> <span class="n">node</span> <span class="n">src</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="nf">js</span>
</code></pre></div></div> <p>Next i needed to build the Docker image and push it into a private Docker Hub repository.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-t</span> taylorgibb/simple-sync
docker push taylorgibb/simple-sync
</code></pre></div></div> <h3 id="creating-a-service-principal">Creating a Service Principal</h3> <p>I needed this function to run under its own service principal. So the first thing i had to do was register a new application and service principal with the appropriate permissions. To do this, i needed two things, <a href="http://gnuwin32.sourceforge.net/packages/openssl.htm">openssl</a>and the <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Azure cli tools.</a></p> <p>First we needed to generate a good <code class="language-plaintext highlighter-rouge">secret</code> to start with, openssl proved to be a useful tool to use for this.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl rand <span class="nt">-base64</span> 24
</code></pre></div></div> <p>Now i can register my application in Azure Active Directory.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az ad app create <span class="nt">--display-name</span> simple-sync
                 <span class="nt">--homepage</span> http://developerhut.co.za
                 <span class="nt">--identifier-uris</span> http://developerhut.co.za
                 <span class="nt">--password</span> <span class="nv">$SECRET</span>
</code></pre></div></div> <p>This returned an <code class="language-plaintext highlighter-rouge">application identifier</code> to me, which i used to create the service principal.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az ad create <span class="nt">--id</span> <span class="nv">$APPLICATION_ID</span>
</code></pre></div></div> <p>The last step was creating a resource group and assigning a role to my newly created service principal. The <code class="language-plaintext highlighter-rouge">az account list</code> command will give me the subscription ID i need to do the role assignment.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az group create <span class="nt">--location</span> westeurope
                <span class="nt">--name</span> simple-sync

az account list

az role assignment create <span class="nt">--assignee</span> http://developerhut.co.za
                          <span class="nt">--role</span> Contributor 
                          <span class="nt">--scope</span> /subscriptions/<span class="nv">$SUBSCRIPTION_ID</span>/resourceGroups/simple-sync
</code></pre></div></div> <p>That was a lot of effort. Nevertheless, i now have a service principal that is constrained to the bounds of my resource group. In addition to better security, we also get better billing and peace of mind.</p> <h3 id="the-functions">The Functions</h3> <p>Next we needed to write a couple of Azure functions that coud create and delete our containers on a schedule. I had never written an Azure function before, but a few searches later and i was installing the <a href="https://github.com/Azure/azure-functions-core-tools">Azure Function Core Tools</a></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">-g</span> azure-function-core-tools
</code></pre></div></div> <p>Once i had the tools installed, i needed to create a new Function App and then create the actual functions within the app. I am going to be creating a time based function using the JavaScript language option and will call my function <code class="language-plaintext highlighter-rouge">provision</code>, this is the first of the two functions i will create.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func init simple-functions
func new
func host start
</code></pre></div></div> <p>I then needed to crack open the <code class="language-plaintext highlighter-rouge">index.js</code> file inside the <code class="language-plaintext highlighter-rouge">provision</code> directory and replace the boilerplate code with our own. My container is hosted in the Docker Hub registry, so you will notice that i pass in a <code class="language-plaintext highlighter-rouge">imageRegistryCredentials</code> parameter so that Azure knows where to get our container from. I am creating a Linux container in West Europe but the function is easy enough to change.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">AZ</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ms-rest-azure</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">ACI</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">azure-arm-containerinstance</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">AZ</span><span class="p">.</span><span class="nx">loginWithServicePrincipalSecret</span><span class="p">(</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_CLIENT_ID</span><span class="p">,</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_CLIENT_SECRET</span><span class="p">,</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_TENANT_ID</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ACI</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_SUBSCRIPTION_ID</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">containerGroups</span><span class="p">.</span><span class="nx">createOrUpdate</span><span class="p">(</span><span class="dl">'</span><span class="s1">simple</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">simple-containers</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">containers</span><span class="p">:</span> <span class="p">[</span><span class="nx">container</span><span class="p">],</span>
            <span class="na">osType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Linux</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">location</span><span class="p">:</span> <span class="dl">'</span><span class="s1">West Europe</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">restartPolicy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">never</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">imageRegistryCredentials</span><span class="p">:</span> <span class="p">[{</span>
                <span class="dl">"</span><span class="s2">server</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">index.docker.io</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DOCKER_USERNAME</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DOCKER_PASSWORD</span><span class="p">}]</span>
        <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">done</span><span class="p">();</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">});</span>   
 <span class="p">};</span>
</code></pre></div></div> <p>Next, i needed to run <code class="language-plaintext highlighter-rouge">npm init</code> in the <code class="language-plaintext highlighter-rouge">provision</code> folder so that npm would generate a <code class="language-plaintext highlighter-rouge">package.json</code> file. I could then added the two dependencies you see in the above code.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install --save azure-arm-containerinstance
npm install --save ms-rest-azure
</code></pre></div></div> <p>I also needed to edit the cron expression in the <code class="language-plaintext highlighter-rouge">function.json</code> file. I tried a couple of online cron expression generators, but Azure didn’t like the expressions that they generated. I found <a href="https://codehollow.com/2017/02/azure-functions-time-trigger-cron-cheat-sheet">this</a> article very useful for crafting expressions. After modification, the trigger was set to fire daily, and looked as follows:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">disabled</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">bindings</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">startTimer</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">timerTrigger</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">direction</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">in</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">schedule</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0 0 0 * * *</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div> <p>Finally, i follow the above steps again and create another function called <code class="language-plaintext highlighter-rouge">delete</code>. Just as above, i had to run <code class="language-plaintext highlighter-rouge">npm init</code> to initialize the project and then install the required modules via <code class="language-plaintext highlighter-rouge">npm</code> with the <code class="language-plaintext highlighter-rouge">--save</code> flag. The contents of the <code class="language-plaintext highlighter-rouge">delete</code> function is below.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ACI</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">azure-arm-containerinstance</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">AZ</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ms-rest-azure</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">AZ</span><span class="p">.</span><span class="nx">loginWithServicePrincipalSecret</span><span class="p">(</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_CLIENT_ID</span><span class="p">,</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_CLIENT_SECRET</span><span class="p">,</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_TENANT_ID</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ACI</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AZURE_SUBSCRIPTION_ID</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">containerGroups</span><span class="p">.</span><span class="nx">deleteMethod</span><span class="p">(</span><span class="dl">'</span><span class="s1">simple</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">simple-containers</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Delete completed</span><span class="dl">'</span><span class="p">,</span> <span class="nx">r</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div> <p>I only wanted the <code class="language-plaintext highlighter-rouge">delete</code> function to get executed 6 hours after the <code class="language-plaintext highlighter-rouge">provision</code> function had started the container, so it has a slightly different <code class="language-plaintext highlighter-rouge">function.json</code> definition too.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">disabled</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">bindings</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">endTimer</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">timerTrigger</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">direction</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">in</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">schedule</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0 0 6 * * *</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div> <p>At this point, i committed my code to a private Github repository</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az storage account create <span class="nt">--name</span> simplestorage <span class="nt">--location</span> westeurope <span class="nt">--resource-group</span> simple-sync <span class="nt">--sku</span> Standard_LRS

az functionapp create <span class="nt">--deployment-source-url</span> https://github.com/taylorgibb/simple-sync
                      <span class="nt">--resource-group</span> simple-sync 
                      <span class="nt">--consumption-plan-location</span> westeurope 
                      <span class="nt">--name</span> simple-functions
                      <span class="nt">--storage-account</span> simplestorage
</code></pre></div></div> <p>In the two functions above, i use environment variables to keep sensitive information from being committed to source control. By definition, environment variables, are configured in the environment itself and that means we need to add a few more things to Azure. The settings i added were generated in the first part of the article on creating a service principal, along with some fake Docker Hub credentials. It goes without saying that these values will need to be substituted with your own if you are following along.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az functionapp config appsettings <span class="nb">set</span> <span class="nt">--name</span> simple-functions
                                      <span class="nt">--resource-group</span> simple
                                      <span class="nt">--settings</span> <span class="nv">AZURE_CLIENT_ID</span><span class="o">=</span>XXX 
                                                 <span class="nv">AZURE_CLIENT_SECRET</span><span class="o">=</span>XXX
                                                 <span class="nv">AZURE_TENANT_ID</span><span class="o">=</span>XXX
                                                 <span class="nv">AZURE_SUBSCRIPTION_ID</span><span class="o">=</span>XXX 
                                                 <span class="nv">DOCKER_USERNAME</span><span class="o">=</span>XXX 
                                                 <span class="nv">DOCKER_PASSWORD</span><span class="o">=</span>XXX 
</code></pre></div></div> <p>Now that all my config is complete, i used some nifty helper methods to mirror it onto my local machine so that i could test the functions locally in the future if i need to. When we run the below, it pulls all the settings into a special file called <code class="language-plaintext highlighter-rouge">local.settings.json</code> which lives in the root of your function app. The <code class="language-plaintext highlighter-rouge">local.settings.json</code> file is in the <code class="language-plaintext highlighter-rouge">.gitignore</code> by default and wont be committed to source control, keeping all your secrets safe.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func azure functionapp fetch-app-settings simple-functions
</code></pre></div></div> <p>Thats pretty much all there was to it. At this point, i logged into the Azure portal and manually ran the <code class="language-plaintext highlighter-rouge">provision</code> function and verified that it created a new container instance, i then ran the <code class="language-plaintext highlighter-rouge">delete</code> function and ensured the container instance was removed. I ran into a couple of issues while making this, most notably with the Azure Function Core Tools there is a bug that prevents you from publishing functions from the command line if your function contains a <code class="language-plaintext highlighter-rouge">node_modules</code> folder. You can read more about that over <a href="https://github.com/Azure/azure-functions-core-tools/issues/352">here</a>.</p> </article> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = "https://www.taylorgibb.com/blog/azure-functions-and-containers", this.page.identifier = "/blog/azure-functions-and-containers"; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://taylorgibb.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <script id="dsq-count-scr" src="//taylorgibb.disqus.com/count.js" async></script> <div class="footer"> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a>, source code on <a href="https://github.com/taylorgibb/taylorgibb.github.io">Github</a></small></span> </div> </body> </html>
